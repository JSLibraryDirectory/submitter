/*!
 * Submitter v0.1.0
 * https://github.com/fengyuanchen/submitter
 *
 * Copyright 2014 Fengyuan Chen
 * Released under the MIT license
 */

!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(window.jQuery)}(function(a){"use strict";function b(c,d){d=a.isPlainObject(d)?d:{},this.$form=a(c),this.defaults=a.extend(!0,{},b.defaults,d),this.init()}b.prototype={constructor:b,support:{formData:!!window.FormData},textStatus:{start:"start",done:"success",fail:"error",end:"complete"},init:function(){var b={beforeSend:a.proxy(this.start,this),success:a.proxy(this.done,this),error:a.proxy(this.fail,this),complete:a.proxy(this.end,this)},c={type:this.$form.attr("method")||"get",url:this.$form.attr("action")||""},d=this.$form.find(":submit"),e=this.$form.find(":reset");this.ajaxOptions=a.extend({},c,this.defaults.ajaxOptions,b),this.$form.find(":file").length>0&&(this.requireUpload=!0,this.support.formData||this.initIframe()),0===d.length&&(d=a('<button type="submit" style="display:none;"></button>'),this.$form.append(d)),0===e.length&&(e=a('<button type="reset" style="display:none;">Reset</button>'),this.$form.append(e)),this.$submit=d,this.$reset=e,this.active()},active:function(){var a=this;this.$form.submit(function(){return a.defaults.isValidated()?!a.requireUpload||a.support.formData?(a.submit(),!1):void a.start(null):!1})},distory:function(){this.$form.off("submit"),this.$form=null,this.$iframe&&(this.$iframe.off("load").remove(),this.$iframe=null)},start:function(b){a.isFunction(this.defaults.start)&&this.defaults.start(),a.isFunction(this.defaults.ajaxOptions.beforeSend)&&this.defaults.ajaxOptions.beforeSend(b)},done:function(b,c,d){a.isFunction(this.defaults.done)&&this.defaults.done(b),a.isFunction(this.defaults.ajaxOptions.success)&&this.defaults.ajaxOptions.success(b,c,d),this.defaults.resetAfterDone&&this.$reset.click()},fail:function(b,c,d){a.isFunction(this.defaults.fail)&&this.defaults.fail(),a.isFunction(this.defaults.ajaxOptions.error)&&this.defaults.ajaxOptions.error(b,c,d)},end:function(b,c){a.isFunction(this.defaults.end)&&this.defaults.end(),a.isFunction(this.defaults.ajaxOptions.complete)&&this.defaults.ajaxOptions.complete(b,c)},submit:function(){var b=a.extend({},this.ajaxOptions);this.support.formData?(b.data=new FormData(this.$form[0]),b.processData=!1,b.contentType=!1):b.data=this.$form.serialize(),a.ajax(b)},initIframe:function(){var b="submitter-"+Math.random().toString().replace("0.",""),c=a('<iframe name="'+b+'" style="display:none;"></iframe>'),d=this;c.on("load",function(){var b,c,e;try{c=this.contentWindow,e=this.contentDocument,e=e?e:c.document,b=e?e.body.innerText:null,b="string"==typeof b?a.parseJSON(b):b}catch(f){d.fail(null,"fail",f.message)}b&&(a.isPlainObject(b)?d.done(b,"done",null):d.fail(null,"fail",d.defaults.messages.fail),d.end(null,"end"))}),this.defaults.ajaxOptions.type&&this.$form.attr("method",this.defaults.ajaxOptions.type),this.$form.attr("target",b).after(c),this.$iframe=c}},b.defaults={resetAfterDone:!1,messages:{start:"Submit start.",done:"Submit done.",fail:"Submit fail.",end:"Submit end."},ajaxOptions:{cache:!1,dataType:"json"},isValidated:function(){return!0},start:function(){},done:function(){},fail:function(){},end:function(){}},b.setDefaults=function(c){a.extend(b.messages,c)},a.fn.submitter=function(c){return this.each(function(){a(this).data("submitter",new b(this,c))})},a.fn.submitter.Constructor=b,a.fn.submitter.setDefaults=b.setDefaults,a(function(){a("form[submitter]").submitter()})});